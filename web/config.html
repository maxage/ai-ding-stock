<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AIè‚¡ç¥¨åˆ†æç³»ç»Ÿ - æ™ºèƒ½ç›‘æ§å¹³å°</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #6366f1;
            --secondary-color: #8b5cf6;
            --success-color: #10b981;
            --danger-color: #ef4444;
            --warning-color: #f59e0b;
            --bg-dark: #0f172a;
            --bg-card: #1e293b;
            --bg-hover: #334155;
            --text-primary: #f1f5f9;
            --text-secondary: #cbd5e1;
            --border-color: #334155;
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.3);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', 'PingFang SC', 'Hiragino Sans GB', 'Microsoft YaHei', sans-serif;
            background: linear-gradient(135deg, #0f172a 0%, #1e293b 100%);
            color: var(--text-primary);
            min-height: 100vh;
            display: flex;
        }

        /* ä¾§è¾¹æ  */
        .sidebar {
            width: 260px;
            background: var(--bg-card);
            border-right: 1px solid var(--border-color);
            display: flex;
            flex-direction: column;
            position: fixed;
            height: 100vh;
            overflow-y: auto;
            z-index: 1000;
        }

        .sidebar-header {
            padding: 24px 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--bg-card);
        }

        .sidebar-header h1 {
            font-size: 20px;
            font-weight: 700;
            margin-bottom: 4px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .sidebar-header .subtitle {
            font-size: 12px;
            opacity: 0.9;
        }

        .sidebar-nav {
            padding: 16px 0;
            flex: 1;
        }

        .nav-item {
            padding: 12px 20px;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text-secondary);
            border-left: 3px solid transparent;
        }

        .nav-item:hover {
            background: var(--bg-hover);
            color: var(--text-primary);
        }

        .nav-item.active {
            background: var(--bg-hover);
            color: var(--text-primary);
            border-left-color: var(--primary-color);
        }

        .nav-item-icon {
            font-size: 18px;
            width: 20px;
            text-align: center;
        }

        .nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* ä¸»å†…å®¹åŒº */
        .main-content {
            flex: 1;
            margin-left: 260px;
            padding: 24px;
            min-height: 100vh;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
        }

        /* é¡¶éƒ¨çŠ¶æ€æ  */
        .top-bar {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 16px 24px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: var(--shadow);
        }

        .status-indicator {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-dot {
            width: 10px;
            height: 10px;
            border-radius: 50%;
            background: var(--success-color);
            animation: pulse 2s infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }

        .status-dot.error {
            background: var(--danger-color);
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: var(--bg-card);
            border-radius: 12px;
            padding: 24px;
            margin-bottom: 24px;
            box-shadow: var(--shadow);
            border: 1px solid var(--border-color);
        }

        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 16px;
            border-bottom: 1px solid var(--border-color);
        }

        .card-title {
            font-size: 18px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        /* æŒ‰é’®æ ·å¼ */
        .btn {
            padding: 10px 20px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 14px;
            font-weight: 500;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 8px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 12px rgba(99, 102, 241, 0.4);
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-success:hover {
            background: #059669;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-danger:hover {
            background: #dc2626;
        }

        .btn-test {
            background: linear-gradient(135deg, #06b6d4, #0891b2);
            color: white;
        }

        .btn-test:hover {
            background: linear-gradient(135deg, #0891b2, #0e7490);
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
            transform: none;
        }

        /* è¡¨å•æ ·å¼ */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: var(--text-secondary);
            font-size: 13px;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px 14px;
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 8px;
            color: var(--text-primary);
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-group small {
            display: block;
            color: var(--text-secondary);
            margin-top: 6px;
            font-size: 12px;
            opacity: 0.8;
        }

        .checkbox-group {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .checkbox-group input[type="checkbox"] {
            width: auto;
            cursor: pointer;
        }

        /* ç½‘æ ¼å¸ƒå±€ */
        .grid-2 {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 16px;
        }

        .grid-3 {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 16px;
        }

        /* è‚¡ç¥¨åˆ—è¡¨ */
        .stock-list {
            display: grid;
            gap: 16px;
        }

        .stock-item {
            background: var(--bg-dark);
            border: 1px solid var(--border-color);
            border-radius: 10px;
            padding: 20px;
            transition: all 0.3s;
        }

        .stock-item:hover {
            border-color: var(--primary-color);
            transform: translateY(-2px);
            box-shadow: var(--shadow);
        }

        .stock-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 16px;
        }

        .stock-item-title {
            font-weight: 600;
            font-size: 16px;
            color: var(--text-primary);
        }

        /* æµ‹è¯•ç»“æœ */
        .test-result {
            margin-top: 20px;
        }

        .test-item {
            padding: 16px;
            background: var(--bg-dark);
            border-radius: 8px;
            margin-bottom: 12px;
            border-left: 4px solid var(--border-color);
        }

        .test-item.passed {
            border-left-color: var(--success-color);
        }

        .test-item.failed {
            border-left-color: var(--danger-color);
        }

        .test-item.warning {
            border-left-color: var(--warning-color);
        }

        .test-item-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .test-item-name {
            font-weight: 600;
            font-size: 14px;
        }

        .test-status-badge {
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 12px;
            font-weight: 600;
        }

        .test-status-badge.passed {
            background: rgba(16, 185, 129, 0.2);
            color: var(--success-color);
        }

        .test-status-badge.failed {
            background: rgba(239, 68, 68, 0.2);
            color: var(--danger-color);
        }

        .test-status-badge.warning {
            background: rgba(245, 158, 11, 0.2);
            color: var(--warning-color);
        }

        /* æç¤ºä¿¡æ¯ */
        .alert {
            padding: 16px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-size: 14px;
            border-left: 4px solid;
        }

        .alert-success {
            background: rgba(16, 185, 129, 0.1);
            border-color: var(--success-color);
            color: var(--success-color);
        }

        .alert-error {
            background: rgba(239, 68, 68, 0.1);
            border-color: var(--danger-color);
            color: var(--danger-color);
        }

        .alert-warning {
            background: rgba(245, 158, 11, 0.1);
            border-color: var(--warning-color);
            color: var(--warning-color);
        }

        .alert-info {
            background: rgba(99, 102, 241, 0.1);
            border-color: var(--primary-color);
            color: var(--primary-color);
        }

        /* åŠ è½½åŠ¨ç”» */
        .loading {
            text-align: center;
            padding: 40px;
            color: var(--text-secondary);
        }

        .spinner {
            border: 3px solid var(--border-color);
            border-top-color: var(--primary-color);
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 16px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* æŒä»“ä¿¡æ¯åŒºåŸŸ */
        .position-fields {
            margin-top: 16px;
            padding-top: 16px;
            border-top: 1px solid var(--border-color);
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stat-card {
            background: linear-gradient(135deg, var(--bg-card), var(--bg-dark));
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
        }

        .stat-value {
            font-size: 32px;
            font-weight: 700;
            margin: 12px 0;
            background: linear-gradient(135deg, var(--primary-color), var(--secondary-color));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .stat-label {
            font-size: 13px;
            color: var(--text-secondary);
        }

        /* å“åº”å¼ */
        @media (max-width: 1024px) {
            .grid-3 {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        @media (max-width: 768px) {
            .sidebar {
                width: 80px;
            }

            .sidebar-header h1,
            .nav-item-text,
            .sidebar-header .subtitle {
                display: none;
            }

            .main-content {
                margin-left: 80px;
            }

            .grid-2,
            .grid-3 {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- ä¾§è¾¹æ  -->
    <div class="sidebar">
        <div class="sidebar-header">
            <h1>ğŸ“ˆ è‚¡ç¥¨åˆ†æç³»ç»Ÿ</h1>
            <div class="subtitle">AIæ™ºèƒ½ç›‘æ§å¹³å°</div>
        </div>
        <div class="sidebar-nav">
            <div class="nav-item active" onclick="showPage('dashboard', this)">
                <span class="nav-item-icon">ğŸ“Š</span>
                <span class="nav-item-text">ç³»ç»Ÿæ¦‚è§ˆ</span>
            </div>
            <div class="nav-item" onclick="showPage('config', this)">
                <span class="nav-item-icon">âš™ï¸</span>
                <span class="nav-item-text">ç³»ç»Ÿé…ç½®</span>
            </div>
            <div class="nav-item" onclick="showPage('stocks', this)">
                <span class="nav-item-icon">ğŸ“ˆ</span>
                <span class="nav-item-text">è‚¡ç¥¨ç›‘æ§</span>
            </div>
            <div class="nav-item" onclick="showPage('analysis', this)">
                <span class="nav-item-icon">ğŸ”</span>
                <span class="nav-item-text">åˆ†æç»“æœ</span>
            </div>
            <div class="nav-item" onclick="showPage('test', this)">
                <span class="nav-item-icon">ğŸ§ª</span>
                <span class="nav-item-text">ç³»ç»Ÿæµ‹è¯•</span>
            </div>
            <div class="nav-item" onclick="showPage('notification', this)">
                <span class="nav-item-icon">ğŸ””</span>
                <span class="nav-item-text">é€šçŸ¥è®¾ç½®</span>
            </div>
        </div>
    </div>

    <!-- ä¸»å†…å®¹åŒº -->
    <div class="main-content">
        <!-- é¡¶éƒ¨çŠ¶æ€æ  -->
        <div class="top-bar">
            <div class="status-indicator">
                <div class="status-dot" id="systemStatus"></div>
                <span id="systemStatusText">ç³»ç»Ÿè¿è¡Œä¸­</span>
            </div>
            <div style="display: flex; gap: 12px; align-items: center;">
                <span style="font-size: 13px; color: var(--text-secondary);" id="currentTime"></span>
                <button class="btn btn-test" onclick="runFullTest()">ğŸ§ª ç«‹å³æµ‹è¯•</button>
            </div>
        </div>

        <div id="alertContainer"></div>

        <!-- ç³»ç»Ÿæ¦‚è§ˆé¡µé¢ -->
        <div id="page-dashboard" class="page active">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ“Š ç³»ç»Ÿæ¦‚è§ˆ</div>
                </div>
                <div class="grid-3" id="dashboardStats">
                    <div class="stat-card">
                        <div class="stat-label">ç›‘æ§è‚¡ç¥¨æ•°</div>
                        <div class="stat-value" id="statTotalStocks">-</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">è¿è¡ŒçŠ¶æ€</div>
                        <div class="stat-value" style="font-size: 24px;" id="statSystemStatus">æ­£å¸¸</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">APIæœåŠ¡</div>
                        <div class="stat-value" style="font-size: 24px;" id="statAPIPort">9090</div>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸš€ å¿«é€Ÿæ“ä½œ</div>
                </div>
                <div style="display: flex; gap: 12px; flex-wrap: wrap;">
                    <button class="btn btn-test" onclick="showPage('test', null); runFullTest()">ğŸ§ª è¿è¡Œç³»ç»Ÿæµ‹è¯•</button>
                    <button class="btn btn-primary" onclick="showPage('stocks', null)">ğŸ“ˆ æŸ¥çœ‹è‚¡ç¥¨ç›‘æ§</button>
                    <button class="btn btn-primary" onclick="showPage('config', null)">âš™ï¸ ç³»ç»Ÿé…ç½®</button>
                </div>
            </div>

            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ“‹ æœ€è¿‘åˆ†æè®°å½•</div>
                </div>
                <div id="recentAnalysis" style="color: var(--text-secondary);">
                    <div style="text-align: center; padding: 20px;">
                        <div class="spinner" style="display: inline-block; width: 20px; height: 20px;"></div>
                        <p style="margin-top: 10px;">æ­£åœ¨åŠ è½½åˆ†æè®°å½•...</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿæµ‹è¯•é¡µé¢ -->
        <div id="page-test" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ§ª ç³»ç»Ÿæµ‹è¯•</div>
                    <button class="btn btn-test" onclick="runFullTest()">ğŸ”„ é‡æ–°æµ‹è¯•</button>
                </div>
                <div id="testResults" class="test-result">
                    <div class="loading">
                        <div class="spinner"></div>
                        <p>ç‚¹å‡»"ç«‹å³æµ‹è¯•"æˆ–"é‡æ–°æµ‹è¯•"å¼€å§‹æµ‹è¯•</p>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç³»ç»Ÿé…ç½®é¡µé¢ -->
        <div id="page-config" class="page">
            <div id="loadingContainer" class="card loading">
                <div class="spinner"></div>
                <p>â³ æ­£åœ¨åŠ è½½é…ç½®...</p>
            </div>

            <div id="configContainer" style="display: none;">
                <!-- TDX APIé…ç½® -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“¡ TDX APIé…ç½®</div>
                    </div>
                    <div class="form-group">
                        <label for="tdx_api_url">TDX APIåœ°å€</label>
                        <input type="text" id="tdx_api_url" placeholder="http://192.168.1.222:8181">
                        <small>é€šè¾¾ä¿¡è‚¡ç¥¨æ•°æ®APIæœåŠ¡åœ°å€</small>
                    </div>
                </div>

                <!-- AIé…ç½® -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ¤– AIæ¨¡å‹é…ç½®</div>
                    </div>
                    <div class="form-group">
                        <label for="ai_provider">AIæä¾›å•†</label>
                        <select id="ai_provider" onchange="toggleAIConfig()">
                            <option value="deepseek">DeepSeekï¼ˆæ¨èï¼‰</option>
                            <option value="qwen">Qwenï¼ˆé€šä¹‰åƒé—®ï¼‰</option>
                            <option value="custom">è‡ªå®šä¹‰API</option>
                        </select>
                        <small>é€‰æ‹©AIåˆ†æå¼•æ“</small>
                    </div>

                    <div id="deepseek_config" class="form-group">
                        <label for="deepseek_key">DeepSeek APIå¯†é’¥</label>
                        <input type="password" id="deepseek_key" placeholder="sk-xxx">
                        <small>ä» https://platform.deepseek.com è·å–</small>
                    </div>

                    <div id="qwen_config" class="form-group" style="display: none;">
                        <label for="qwen_key">Qwen APIå¯†é’¥</label>
                        <input type="password" id="qwen_key" placeholder="sk-xxx">
                        <small>ä» https://dashscope.aliyun.com è·å–</small>
                    </div>

                    <div id="custom_config" style="display: none;">
                        <div class="form-group">
                            <label for="custom_api_url">è‡ªå®šä¹‰APIåœ°å€</label>
                            <input type="text" id="custom_api_url" placeholder="https://api.openai.com/v1">
                            <small>å…¼å®¹OpenAIæ ¼å¼çš„APIåŸºç¡€åœ°å€</small>
                        </div>
                        <div class="form-group">
                            <label for="custom_api_key">è‡ªå®šä¹‰APIå¯†é’¥</label>
                            <input type="password" id="custom_api_key" placeholder="sk-xxx">
                        </div>
                        <div class="form-group">
                            <label for="custom_model_name">æ¨¡å‹åç§°</label>
                            <input type="text" id="custom_model_name" placeholder="gpt-4o">
                            <small>ä¾‹å¦‚: gpt-4o, claude-3-5-sonnet-20241022</small>
                        </div>
                    </div>
                </div>

                <!-- äº¤æ˜“æ—¶é—´é…ç½® -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">â° äº¤æ˜“æ—¶é—´é…ç½®</div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="trading_time_enable">
                        <label for="trading_time_enable">å¯ç”¨äº¤æ˜“æ—¶é—´æ£€æŸ¥</label>
                        <small style="margin-left: 30px;">å¯ç”¨åä»…åœ¨äº¤æ˜“æ—¶æ®µè¿›è¡Œåˆ†æ</small>
                    </div>
                    <div class="form-group">
                        <label for="trading_hours">äº¤æ˜“æ—¶æ®µ</label>
                        <input type="text" id="trading_hours" placeholder='["09:30-11:30", "13:00-15:00"]'>
                        <small>JSONæ•°ç»„æ ¼å¼ï¼Œå¤šä¸ªæ—¶æ®µç”¨é€—å·åˆ†éš”</small>
                    </div>
                    <div class="form-group">
                        <label for="timezone">æ—¶åŒº</label>
                        <input type="text" id="timezone" placeholder="Asia/Shanghai">
                    </div>
                </div>

                <!-- ç³»ç»Ÿé…ç½® -->
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ”§ ç³»ç»Ÿé…ç½®</div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label for="api_server_port">APIæœåŠ¡ç«¯å£</label>
                            <input type="number" id="api_server_port" placeholder="9090">
                        </div>
                        <div class="form-group">
                            <label for="log_dir">æ—¥å¿—ç›®å½•</label>
                            <input type="text" id="log_dir" placeholder="stock_analysis_logs">
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="api_token">API Tokenï¼ˆç”¨äºé‡å¯ç­‰æœåŠ¡ï¼‰</label>
                        <input type="password" id="api_token" placeholder="é»˜è®¤: 1122334455667788">
                        <small>ç”¨äºå‰ç«¯é‡å¯åç«¯ç­‰æ“ä½œçš„è®¤è¯Tokenã€‚é»˜è®¤å€¼: 1122334455667788ï¼ˆä¸ºäº†å®‰å…¨ï¼Œå¼ºçƒˆå»ºè®®ä¿®æ”¹ï¼ï¼‰ã€‚å¯åœ¨ç¯å¢ƒå˜é‡ä¸­è®¾ç½® API_TOKENï¼Œæˆ–åœ¨æ­¤å¤„æ‰‹åŠ¨é…ç½®ã€‚å»ºè®®ä½¿ç”¨å¼ºå¯†ç ã€‚</small>
                    </div>
                    <div class="form-group">
                        <label for="analysis_history_limit">åˆ†æå†å²è®°å½•æ•°é‡</label>
                        <input type="number" id="analysis_history_limit" min="3" max="100" placeholder="20">
                        <small>æ¯ä¸ªè‚¡ç¥¨æœ€å¤šä¿å­˜çš„åˆ†æè®°å½•æ•°ã€‚èŒƒå›´ï¼š3-100æ¡ï¼Œé»˜è®¤20æ¡ã€‚ç³»ç»Ÿæ¦‚è§ˆä¸­åªæ˜¾ç¤º3æ¡ï¼Œå…¶ä½™å¯é€šè¿‡æ»šåŠ¨æ¡æŸ¥çœ‹ã€‚</small>
                    </div>
                </div>

                <!-- ä¿å­˜æŒ‰é’®å’Œé‡å¯æŒ‰é’® -->
                <div class="card">
                    <div style="text-align: center;">
                        <button class="btn btn-primary" onclick="saveConfig()" style="padding: 14px 40px; font-size: 16px; margin-right: 12px;">
                            ğŸ’¾ ä¿å­˜é…ç½®
                        </button>
                        <button class="btn btn-test" onclick="restartBackend()" style="padding: 14px 40px; font-size: 16px;">
                            ğŸ”„ é‡å¯åç«¯
                        </button>
                        <p style="margin-top: 15px; color: var(--text-secondary); font-size: 14px;">
                            âš ï¸ ä¿å­˜åéœ€è¦é‡å¯ç¨‹åºæ‰èƒ½ç”Ÿæ•ˆ | ğŸ”„ é‡å¯åç«¯éœ€è¦æä¾›æ­£ç¡®çš„API Token
                        </p>
                    </div>
                </div>
            </div>
        </div>

        <!-- è‚¡ç¥¨ç›‘æ§é¡µé¢ -->
        <div id="page-stocks" class="page">
            <div id="loadingContainerStocks" class="card loading">
                <div class="spinner"></div>
                <p>â³ æ­£åœ¨åŠ è½½è‚¡ç¥¨åˆ—è¡¨...</p>
            </div>

            <div id="stocksContainer" style="display: none;">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ“Š ç›‘æ§è‚¡ç¥¨é…ç½®</div>
                        <button class="btn btn-primary" onclick="addStock()">â• æ·»åŠ è‚¡ç¥¨</button>
                    </div>
                    <div id="stockList" class="stock-list"></div>
                    <div style="margin-top: 20px; text-align: center;">
                        <button class="btn btn-primary" onclick="saveStockConfig()">ğŸ’¾ ä¿å­˜è‚¡ç¥¨é…ç½®</button>
                    </div>
                </div>

                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ¯ æ‰‹åŠ¨æµ‹è¯•åˆ†æ</div>
                    </div>
                    <div id="testStocksList" style="display: grid; gap: 12px;"></div>
                </div>
            </div>
        </div>

        <!-- åˆ†æç»“æœé¡µé¢ -->
        <div id="page-analysis" class="page">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">ğŸ” åˆ†æç»“æœ</div>
                </div>
                <div id="analysisResults" style="color: var(--text-secondary);">
                    æš‚æ— åˆ†æç»“æœï¼Œè¯·ç­‰å¾…è‡ªåŠ¨åˆ†ææˆ–æ‰‹åŠ¨è§¦å‘åˆ†æ
                </div>
            </div>
        </div>

        <!-- é€šçŸ¥è®¾ç½®é¡µé¢ -->
        <div id="page-notification" class="page">
            <div id="loadingContainerNotif" class="card loading" style="display: none;">
                <div class="spinner"></div>
                <p>â³ æ­£åœ¨åŠ è½½é€šçŸ¥é…ç½®...</p>
            </div>

            <div id="notificationContainer">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">ğŸ”” é€šçŸ¥é…ç½®</div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" id="notification_enabled">
                        <label for="notification_enabled">å¯ç”¨é€šçŸ¥ç³»ç»Ÿ</label>
                    </div>

                    <div style="margin: 20px 0; padding: 16px; background: var(--bg-dark); border-radius: 8px; border-left: 4px solid var(--primary-color);">
                        <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">ğŸ’¡ æç¤º</div>
                        <div style="font-size: 13px; color: var(--text-primary); line-height: 1.6;">
                            é…ç½®é€šçŸ¥åï¼Œå½“è‚¡ç¥¨åˆ†æç³»ç»Ÿäº§ç”Ÿäº¤æ˜“ä¿¡å·æ—¶ï¼Œä¼šè‡ªåŠ¨å‘é€é€šçŸ¥åˆ°æ‚¨é…ç½®çš„é’‰é’‰æˆ–é£ä¹¦ç¾¤ã€‚
                            å¦‚æœé…ç½®é¡µé¢æ­£åœ¨åŠ è½½ï¼Œè¯·ç¡®ä¿åç«¯æœåŠ¡æ­£å¸¸è¿è¡Œï¼Œå¹¶åˆ·æ–°é¡µé¢ã€‚
                        </div>
                    </div>

                    <div id="notification_settings">
                        <h3 style="margin: 20px 0 15px 0; font-size: 16px; color: var(--text-primary);">é’‰é’‰é€šçŸ¥</h3>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="dingtalk_enabled">
                            <label for="dingtalk_enabled">å¯ç”¨é’‰é’‰é€šçŸ¥</label>
                        </div>
                        <div class="form-group">
                            <label for="dingtalk_webhook">é’‰é’‰Webhookåœ°å€</label>
                            <input type="text" id="dingtalk_webhook" placeholder="https://oapi.dingtalk.com/robot/send?access_token=xxx">
                        </div>
                        <div class="form-group">
                            <label for="dingtalk_secret">é’‰é’‰Secretï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="dingtalk_secret" placeholder="aiagentsé€šçŸ¥">
                        </div>

                        <h3 style="margin: 20px 0 15px 0; font-size: 16px; color: var(--text-primary);">é£ä¹¦é€šçŸ¥</h3>
                        <div class="form-group checkbox-group">
                            <input type="checkbox" id="feishu_enabled">
                            <label for="feishu_enabled">å¯ç”¨é£ä¹¦é€šçŸ¥</label>
                        </div>
                        <div class="form-group">
                            <label for="feishu_webhook">é£ä¹¦Webhookåœ°å€</label>
                            <input type="text" id="feishu_webhook" placeholder="https://open.feishu.cn/open-apis/bot/v2/hook/xxx">
                        </div>
                        <div class="form-group">
                            <label for="feishu_secret">é£ä¹¦Secretï¼ˆå¯é€‰ï¼‰</label>
                            <input type="text" id="feishu_secret">
                        </div>
                    </div>

                    <div style="margin-top: 24px; text-align: center;">
                        <button class="btn btn-primary" onclick="saveNotificationConfig()">ğŸ’¾ ä¿å­˜é€šçŸ¥é…ç½®</button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let currentConfig = null;
        let currentPage = 'dashboard';

        // é¡µé¢åŠ è½½
        window.onload = function() {
            updateTime();
            setInterval(updateTime, 1000);
            checkSystemStatus();
            setInterval(checkSystemStatus, 5000);
            
            // å¼‚æ­¥åŠ è½½é…ç½®
            loadConfig().then(() => {
                loadStocks();
                updateDashboard();
                loadNotificationConfig();
                loadRecentAnalysis(); // åŠ è½½æœ€è¿‘åˆ†æè®°å½•
            }).catch(error => {
                console.error('åˆå§‹åŒ–å¤±è´¥:', error);
                showAlert('error', 'ç³»ç»Ÿåˆå§‹åŒ–å¤±è´¥ï¼Œè¯·æ£€æŸ¥åç«¯æœåŠ¡æ˜¯å¦æ­£å¸¸è¿è¡Œ');
            });
        };

        // æ›´æ–°æ—¶é—´
        function updateTime() {
            const now = new Date();
            document.getElementById('currentTime').textContent = now.toLocaleString('zh-CN');
        }

        // æ£€æŸ¥ç³»ç»ŸçŠ¶æ€
        async function checkSystemStatus() {
            try {
                const response = await fetch('/health');
                if (response.ok) {
                    const data = await response.json();
                    if (data.status === 'ok') {
                        document.getElementById('systemStatus').className = 'status-dot';
                        document.getElementById('systemStatusText').textContent = 'ç³»ç»Ÿè¿è¡Œä¸­';
                        document.getElementById('statSystemStatus').textContent = 'æ­£å¸¸è¿è¡Œ';
                    } else {
                        document.getElementById('systemStatus').className = 'status-dot error';
                        document.getElementById('systemStatusText').textContent = 'ç³»ç»Ÿå¼‚å¸¸';
                        document.getElementById('statSystemStatus').textContent = 'å¼‚å¸¸';
                    }
                } else {
                    document.getElementById('systemStatus').className = 'status-dot error';
                    document.getElementById('systemStatusText').textContent = 'ç³»ç»Ÿå¼‚å¸¸';
                    document.getElementById('statSystemStatus').textContent = 'å¼‚å¸¸';
                }
            } catch (error) {
                document.getElementById('systemStatus').className = 'status-dot error';
                document.getElementById('systemStatusText').textContent = 'è¿æ¥å¤±è´¥';
                document.getElementById('statSystemStatus').textContent = 'è¿æ¥å¤±è´¥';
            }
        }

        // åˆ‡æ¢é¡µé¢
        function showPage(pageId, navItemElement) {
            // éšè—æ‰€æœ‰é¡µé¢
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            // ç§»é™¤æ‰€æœ‰å¯¼èˆªé¡¹çš„activeçŠ¶æ€
            document.querySelectorAll('.nav-item').forEach((item, index) => {
                item.classList.remove('active');
                // æ£€æŸ¥æ˜¯å¦æ˜¯å½“å‰é¡µé¢å¯¹åº”çš„å¯¼èˆªé¡¹
                const navItems = ['dashboard', 'config', 'stocks', 'analysis', 'test', 'notification'];
                if (navItems[index] === pageId) {
                    item.classList.add('active');
                }
            });
            
            // å¦‚æœä¼ å…¥äº†å¯¼èˆªé¡¹å…ƒç´ ï¼Œä¹Ÿæ¿€æ´»å®ƒï¼ˆç”¨äºç‚¹å‡»å¯¼èˆªé¡¹æ—¶ï¼‰
            if (navItemElement) {
                navItemElement.classList.add('active');
            }

            // æ˜¾ç¤ºç›®æ ‡é¡µé¢
            const targetPage = document.getElementById(`page-${pageId}`);
            if (targetPage) {
                targetPage.classList.add('active');
            }
            
            currentPage = pageId;

            // é¡µé¢ç‰¹å®šåŠ è½½
            if (pageId === 'stocks') {
                loadStocks();
            } else if (pageId === 'dashboard') {
                updateDashboard();
                loadRecentAnalysis(); // åˆ·æ–°æœ€è¿‘åˆ†æè®°å½•
            } else if (pageId === 'notification') {
                if (!currentConfig) {
                    loadConfig().then(() => {
                        loadNotificationConfig();
                    });
                } else {
                    loadNotificationConfig();
                }
            }
        }

        // æ›´æ–°ä»ªè¡¨æ¿
        async function updateDashboard() {
            try {
                const response = await fetch('/api/stocks');
                const result = await response.json();
                if (result.code === 0) {
                    document.getElementById('statTotalStocks').textContent = result.data.total;
                }
            } catch (error) {
                console.error('æ›´æ–°ä»ªè¡¨æ¿å¤±è´¥:', error);
            }
        }

        // ä¿¡å·æ˜ å°„å‡½æ•°ï¼šå°†è‹±æ–‡ä¿¡å·è½¬ä¸ºä¸­æ–‡
        function getSignalText(signal) {
            switch(signal) {
                case 'BUY':
                    return 'ä¹°å…¥';
                case 'SELL':
                    return 'å–å‡º';
                case 'HOLD':
                    return 'æŒæœ‰';
                default:
                    return signal;
            }
        }

        // åŠ è½½æœ€è¿‘åˆ†æè®°å½•
        async function loadRecentAnalysis() {
            const container = document.getElementById('recentAnalysis');
            if (!container) return;

            try {
                // è·å–é…ç½®ä¸­çš„åˆ†æå†å²è®°å½•æ•°é‡é™åˆ¶ï¼Œé»˜è®¤20æ¡
                const limit = (currentConfig && currentConfig.analysis_history_limit) ? currentConfig.analysis_history_limit : 20;
                const response = await fetch(`/api/analysis/recent?limit=${limit}`);
                const result = await response.json();

                if (result.code === 0 && result.data && result.data.records && result.data.records.length > 0) {
                    const records = result.data.records;
                    
                    // ç³»ç»Ÿæ¦‚è§ˆä¸­åªæ˜¾ç¤ºå‰3æ¡ï¼Œå…¶ä½™ç”¨æ»šåŠ¨æ¡æŸ¥çœ‹
                    const displayLimit = 3; // ç³»ç»Ÿæ¦‚è§ˆä¸­å›ºå®šæ˜¾ç¤º3æ¡
                    const visibleRecords = records.slice(0, displayLimit);
                    const scrollableRecords = records.slice(displayLimit);
                    
                    let html = '<div style="display: grid; gap: 12px;">';
                    
                    // å…ˆæ˜¾ç¤ºå‰3æ¡ï¼ˆå›ºå®šæ˜¾ç¤ºï¼‰
                    visibleRecords.forEach((record) => {
                        const signalColor = record.signal === 'BUY' ? 'var(--success-color)' : 
                                          record.signal === 'SELL' ? 'var(--danger-color)' : 
                                          'var(--warning-color)';
                        const signalEmoji = record.signal === 'BUY' ? 'ğŸš€' : 
                                          record.signal === 'SELL' ? 'âš ï¸' : 
                                          'â¸ï¸';
                        const signalText = getSignalText(record.signal); // ä½¿ç”¨ä¸­æ–‡ä¿¡å·
                        const time = new Date(record.timestamp).toLocaleString('zh-CN');
                        
                        html += `
                            <div style="padding: 12px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid ${signalColor};">
                                <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                    <div style="font-weight: 600; color: var(--text-primary);">
                                        ${signalEmoji} ${record.stock_name}(${record.stock_code})
                                    </div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${time}</div>
                                </div>
                                <div style="display: flex; gap: 16px; font-size: 13px;">
                                    <div>
                                        <span style="color: var(--text-secondary);">ä¿¡å·:</span>
                                        <span style="color: ${signalColor}; font-weight: 600; margin-left: 4px;">${signalText}</span>
                                    </div>
                                    <div>
                                        <span style="color: var(--text-secondary);">ä»·æ ¼:</span>
                                        <span style="color: var(--text-primary); margin-left: 4px;">Â¥${record.current_price.toFixed(2)}</span>
                                    </div>
                                    <div>
                                        <span style="color: var(--text-secondary);">ä¿¡å¿ƒåº¦:</span>
                                        <span style="color: var(--text-primary); margin-left: 4px;">${record.confidence}%</span>
                                    </div>
                                </div>
                            </div>
                        `;
                    });
                    
                    // å¦‚æœæœ‰æ›´å¤šè®°å½•ï¼Œæ˜¾ç¤ºåœ¨æ»šåŠ¨åŒºåŸŸå†…
                    if (scrollableRecords.length > 0) {
                        html += '</div>'; // å…³é—­å›ºå®šæ˜¾ç¤ºåŒºåŸŸ
                        html += '<div style="margin-top: 12px; padding-top: 12px; border-top: 1px solid var(--border-color); max-height: 400px; overflow-y: auto; padding-right: 8px;">';
                        html += `<div style="font-size: 12px; color: var(--text-secondary); margin-bottom: 8px;">æ›´å¤šè®°å½• (å…±${records.length}æ¡ï¼Œä¸‹æ–¹å¯æ»šåŠ¨æŸ¥çœ‹):</div>`;
                        html += '<div style="display: grid; gap: 12px;">';
                        
                        scrollableRecords.forEach((record) => {
                            const signalColor = record.signal === 'BUY' ? 'var(--success-color)' : 
                                              record.signal === 'SELL' ? 'var(--danger-color)' : 
                                              'var(--warning-color)';
                            const signalEmoji = record.signal === 'BUY' ? 'ğŸš€' : 
                                              record.signal === 'SELL' ? 'âš ï¸' : 
                                              'â¸ï¸';
                            const signalText = getSignalText(record.signal); // ä½¿ç”¨ä¸­æ–‡ä¿¡å·
                            const time = new Date(record.timestamp).toLocaleString('zh-CN');
                            
                            html += `
                                <div style="padding: 12px; background: var(--bg-card); border-radius: 8px; border-left: 4px solid ${signalColor};">
                                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;">
                                        <div style="font-weight: 600; color: var(--text-primary);">
                                            ${signalEmoji} ${record.stock_name}(${record.stock_code})
                                        </div>
                                        <div style="font-size: 12px; color: var(--text-secondary);">${time}</div>
                                    </div>
                                    <div style="display: flex; gap: 16px; font-size: 13px;">
                                        <div>
                                            <span style="color: var(--text-secondary);">ä¿¡å·:</span>
                                            <span style="color: ${signalColor}; font-weight: 600; margin-left: 4px;">${signalText}</span>
                                        </div>
                                        <div>
                                            <span style="color: var(--text-secondary);">ä»·æ ¼:</span>
                                            <span style="color: var(--text-primary); margin-left: 4px;">Â¥${record.current_price.toFixed(2)}</span>
                                        </div>
                                        <div>
                                            <span style="color: var(--text-secondary);">ä¿¡å¿ƒåº¦:</span>
                                            <span style="color: var(--text-primary); margin-left: 4px;">${record.confidence}%</span>
                                        </div>
                                    </div>
                                </div>
                            `;
                        });
                        
                        html += '</div></div>'; // å…³é—­æ»šåŠ¨åŒºåŸŸ
                    } else {
                        html += '</div>'; // å¦‚æœæ²¡æœ‰æ›´å¤šè®°å½•ï¼Œç›´æ¥å…³é—­å›ºå®šæ˜¾ç¤ºåŒºåŸŸ
                    }
                    
                    container.innerHTML = html;
                } else {
                    container.innerHTML = '<div style="color: var(--text-secondary); text-align: center; padding: 20px;">æš‚æ— åˆ†æè®°å½•</div>';
                }
            } catch (error) {
                console.error('åŠ è½½æœ€è¿‘åˆ†æè®°å½•å¤±è´¥:', error);
                container.innerHTML = '<div style="color: var(--danger-color); text-align: center; padding: 20px;">åŠ è½½å¤±è´¥ï¼Œè¯·ç¨åé‡è¯•</div>';
            }
        }

        // è¿è¡Œå®Œæ•´æµ‹è¯•
        async function runFullTest() {
            const testResultsDiv = document.getElementById('testResults');
            testResultsDiv.innerHTML = '<div class="loading"><div class="spinner"></div><p>æ­£åœ¨æ‰§è¡Œç³»ç»Ÿæµ‹è¯•...</p></div>';

            try {
                const response = await fetch('/api/test', {
                    method: 'POST'
                });
                const result = await response.json();

                if (result.code === 0) {
                    displayTestResults(result.data);
                } else {
                    testResultsDiv.innerHTML = `<div class="alert alert-error">æµ‹è¯•å¤±è´¥: ${result.message}</div>`;
                }
            } catch (error) {
                testResultsDiv.innerHTML = `<div class="alert alert-error">æµ‹è¯•è¯·æ±‚å¤±è´¥: ${error.message}</div>`;
            }
        }

        // æ˜¾ç¤ºæµ‹è¯•ç»“æœ
        function displayTestResults(data) {
            const testResultsDiv = document.getElementById('testResults');
            let html = '';

            if (data.success) {
                html += '<div class="alert alert-success">âœ… æ‰€æœ‰æµ‹è¯•é€šè¿‡ï¼ç³»ç»Ÿè¿è¡Œæ­£å¸¸</div>';
            } else {
                html += `<div class="alert alert-warning">âš ï¸ éƒ¨åˆ†æµ‹è¯•æœªé€šè¿‡ (${data.passed}/${data.total} é€šè¿‡)</div>`;
            }

            html += '<div style="margin-top: 20px;">';
            data.tests.forEach(test => {
                const statusClass = test.status || 'failed';
                html += `
                    <div class="test-item ${statusClass}">
                        <div class="test-item-header">
                            <div class="test-item-name">${test.name}</div>
                            <div class="test-status-badge ${statusClass}">${test.status === 'passed' ? 'âœ“ é€šè¿‡' : test.status === 'warning' ? 'âš  è­¦å‘Š' : 'âœ— å¤±è´¥'}</div>
                        </div>
                        <div style="color: var(--text-secondary); font-size: 13px; margin-top: 8px;">${test.message}</div>
                    </div>
                `;
            });
            html += '</div>';

            testResultsDiv.innerHTML = html;
        }

        // åŠ è½½é…ç½®
        async function loadConfig() {
            try {
                const response = await fetch('/api/config');
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: ${response.statusText}`);
                }
                const result = await response.json();

                if (result.code === 0) {
                    currentConfig = result.data;
                    populateForm(currentConfig);
                    
                    const loadingEl = document.getElementById('loadingContainer');
                    const configEl = document.getElementById('configContainer');
                    if (loadingEl) loadingEl.style.display = 'none';
                    if (configEl) configEl.style.display = 'block';
                    
                    // åŠ è½½é€šçŸ¥é…ç½®
                    populateNotificationForm(currentConfig);
                    
                    // åŠ è½½é€šçŸ¥é¡µé¢
                    loadNotificationConfig();
                } else {
                    throw new Error(result.message || 'åŠ è½½é…ç½®å¤±è´¥');
                }
            } catch (error) {
                console.error('åŠ è½½é…ç½®å¤±è´¥:', error);
                showAlert('error', 'åŠ è½½é…ç½®å¤±è´¥: ' + error.message);
                // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºé…ç½®ç•Œé¢
                const loadingEl = document.getElementById('loadingContainer');
                const configEl = document.getElementById('configContainer');
                if (loadingEl) loadingEl.style.display = 'none';
                if (configEl) configEl.style.display = 'block';
            }
        }

        // å¡«å……è¡¨å•
        function populateForm(config) {
            document.getElementById('tdx_api_url').value = config.tdx_api_url || '';
            document.getElementById('ai_provider').value = config.ai_config?.provider || 'deepseek';
            document.getElementById('deepseek_key').value = config.ai_config?.deepseek_key || '';
            document.getElementById('qwen_key').value = config.ai_config?.qwen_key || '';
            document.getElementById('custom_api_url').value = config.ai_config?.custom_api_url || '';
            document.getElementById('custom_api_key').value = config.ai_config?.custom_api_key || '';
            document.getElementById('custom_model_name').value = config.ai_config?.custom_model_name || '';
            toggleAIConfig();

            document.getElementById('trading_time_enable').checked = config.trading_time?.enable_check || false;
            document.getElementById('trading_hours').value = JSON.stringify(config.trading_time?.trading_hours || ["09:30-11:30", "13:00-15:00"]);
            document.getElementById('timezone').value = config.trading_time?.timezone || 'Asia/Shanghai';

            document.getElementById('api_server_port').value = config.api_server_port || 9090;
            document.getElementById('log_dir').value = config.log_dir || 'stock_analysis_logs';
            document.getElementById('analysis_history_limit').value = config.analysis_history_limit || 20;
            
            // API Tokenï¼ˆæ˜¾ç¤ºæ—¶éšè—çœŸå®å€¼ï¼Œåªæ˜¾ç¤ºéƒ¨åˆ†ï¼‰
            if (config.api_token && config.api_token.trim() !== '') {
                const tokenValue = config.api_token;
                // ä¿å­˜çœŸå®Tokenåˆ°éšè—å­—æ®µæˆ–localStorageï¼Œç”¨äºé‡å¯æ—¶ä½¿ç”¨
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('api_token_real', tokenValue);
                }
                // æ˜¾ç¤ºæ—¶åªæ˜¾ç¤ºéƒ¨åˆ†å­—ç¬¦
                if (tokenValue.length > 10) {
                    document.getElementById('api_token').value = tokenValue.substring(0, 4) + '*'.repeat(Math.min(8, tokenValue.length - 8)) + tokenValue.substring(tokenValue.length - 4);
                } else {
                    document.getElementById('api_token').value = tokenValue;
                }
            } else {
                // å¦‚æœæ²¡æœ‰Tokenï¼Œæ˜¾ç¤ºé»˜è®¤å€¼
                document.getElementById('api_token').value = '1122334455667788';
                if (typeof(Storage) !== "undefined") {
                    localStorage.setItem('api_token_real', '1122334455667788');
                }
            }

            // æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨
            if (config.stocks) {
                renderStockList(config.stocks);
            }
        }

        // å¡«å……é€šçŸ¥è¡¨å•
        function populateNotificationForm(config) {
            document.getElementById('notification_enabled').checked = config.notification?.enabled || false;
            document.getElementById('dingtalk_enabled').checked = config.notification?.dingtalk?.enabled || false;
            document.getElementById('dingtalk_webhook').value = config.notification?.dingtalk?.webhook_url || '';
            document.getElementById('dingtalk_secret').value = config.notification?.dingtalk?.secret || '';
            document.getElementById('feishu_enabled').checked = config.notification?.feishu?.enabled || false;
            document.getElementById('feishu_webhook').value = config.notification?.feishu?.webhook_url || '';
            document.getElementById('feishu_secret').value = config.notification?.feishu?.secret || '';
        }

        // åŠ è½½é€šçŸ¥é…ç½®
        function loadNotificationConfig() {
            try {
                if (currentConfig && currentConfig.notification) {
                    populateNotificationForm(currentConfig);
                } else {
                    // å¦‚æœé…ç½®ä¸­æ²¡æœ‰é€šçŸ¥è®¾ç½®ï¼Œä½¿ç”¨é»˜è®¤å€¼
                    document.getElementById('notification_enabled').checked = false;
                    document.getElementById('dingtalk_enabled').checked = false;
                    document.getElementById('dingtalk_webhook').value = '';
                    document.getElementById('dingtalk_secret').value = '';
                    document.getElementById('feishu_enabled').checked = false;
                    document.getElementById('feishu_webhook').value = '';
                    document.getElementById('feishu_secret').value = '';
                }
                
                // æ˜¾ç¤ºé€šçŸ¥é…ç½®å®¹å™¨ï¼ˆéšè—åŠ è½½åŠ¨ç”»ï¼‰
                const loadingEl = document.getElementById('loadingContainerNotif');
                const containerEl = document.getElementById('notificationContainer');
                if (loadingEl) loadingEl.style.display = 'none';
                if (containerEl) containerEl.style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½é€šçŸ¥é…ç½®å¤±è´¥:', error);
                // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºé…ç½®ç•Œé¢
                const loadingEl = document.getElementById('loadingContainerNotif');
                const containerEl = document.getElementById('notificationContainer');
                if (loadingEl) loadingEl.style.display = 'none';
                if (containerEl) containerEl.style.display = 'block';
            }
        }

        // åˆ‡æ¢AIé…ç½®æ˜¾ç¤º
        function toggleAIConfig() {
            const provider = document.getElementById('ai_provider').value;
            document.getElementById('deepseek_config').style.display = provider === 'deepseek' ? 'block' : 'none';
            document.getElementById('qwen_config').style.display = provider === 'qwen' ? 'block' : 'none';
            document.getElementById('custom_config').style.display = provider === 'custom' ? 'block' : 'none';
        }

        // æ¸²æŸ“è‚¡ç¥¨åˆ—è¡¨
        function renderStockList(stocks) {
            const container = document.getElementById('stockList');
            container.innerHTML = '';

            stocks.forEach((stock, index) => {
                const stockItem = document.createElement('div');
                stockItem.className = 'stock-item';
                stockItem.innerHTML = `
                    <div class="stock-item-header">
                        <div class="stock-item-title">è‚¡ç¥¨ #${index + 1} - ${stock.name || stock.code}</div>
                        <button class="btn btn-danger" onclick="removeStock(${index})">åˆ é™¤</button>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>è‚¡ç¥¨ä»£ç </label>
                            <input type="text" class="stock-code" data-index="${index}" value="${stock.code || ''}" placeholder="000001">
                        </div>
                        <div class="form-group">
                            <label>è‚¡ç¥¨åç§°</label>
                            <input type="text" class="stock-name" data-index="${index}" value="${stock.name || ''}" placeholder="å¹³å®‰é“¶è¡Œ">
                        </div>
                    </div>
                    <div class="grid-2">
                        <div class="form-group">
                            <label>æ‰«æé—´éš”ï¼ˆåˆ†é’Ÿï¼‰</label>
                            <input type="number" class="stock-interval" data-index="${index}" value="${stock.scan_interval_minutes || 5}" placeholder="5">
                        </div>
                        <div class="form-group">
                            <label>æœ€å°ä¿¡å¿ƒåº¦ï¼ˆ%ï¼‰</label>
                            <input type="number" class="stock-confidence" data-index="${index}" value="${stock.min_confidence || 70}" placeholder="70">
                        </div>
                    </div>
                    <div class="form-group checkbox-group">
                        <input type="checkbox" class="stock-enabled" data-index="${index}" ${stock.enabled ? 'checked' : ''}>
                        <label>å¯ç”¨æ­¤è‚¡ç¥¨</label>
                    </div>
                    <div class="position-fields">
                        <label style="font-weight: 600; margin-bottom: 10px; display: block;">ğŸ“Š æŒä»“ä¿¡æ¯ï¼ˆå¯é€‰ï¼‰</label>
                        <small style="display: block; margin-bottom: 10px; opacity: 0.8;">å¦‚æœä¸å¡«å†™ï¼Œå°†æŒ‰ç›‘æ§æ¨¡å¼è¿è¡Œï¼ˆä»…æŠ€æœ¯åˆ†æï¼‰</small>
                        <div class="grid-2">
                            <div class="form-group">
                                <label>æŒä»“æ•°é‡ï¼ˆè‚¡ï¼‰</label>
                                <input type="number" class="stock-position-quantity" data-index="${index}" value="${stock.position_quantity || ''}" placeholder="1000">
                            </div>
                            <div class="form-group">
                                <label>è´­ä¹°ä»·æ ¼ï¼ˆå…ƒ/è‚¡ï¼‰</label>
                                <input type="number" step="0.01" class="stock-buy-price" data-index="${index}" value="${stock.buy_price || ''}" placeholder="12.50">
                            </div>
                        </div>
                        <div class="form-group">
                            <label>è´­ä¹°æ—¥æœŸï¼ˆå¯é€‰ï¼‰</label>
                            <input type="date" class="stock-buy-date" data-index="${index}" value="${stock.buy_date || ''}">
                            <small>è´­ä¹°æ—¥æœŸï¼Œç”¨äºè®¡ç®—æŒä»“å¤©æ•°</small>
                        </div>
                    </div>
                `;
                container.appendChild(stockItem);
            });

            // æ›´æ–°æµ‹è¯•è‚¡ç¥¨åˆ—è¡¨
            updateTestStocksList(stocks);
        }

        // æ›´æ–°æµ‹è¯•è‚¡ç¥¨åˆ—è¡¨
        function updateTestStocksList(stocks) {
            const container = document.getElementById('testStocksList');
            if (!container) return;
            
            container.innerHTML = '';

            if (!stocks || stocks.length === 0) {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— è‚¡ç¥¨é…ç½®ï¼Œè¯·å…ˆæ·»åŠ è‚¡ç¥¨</div>';
                return;
            }

            stocks.forEach((stock, index) => {
                if (stock && stock.code) {
                    const testItem = document.createElement('div');
                    testItem.style.cssText = 'display: flex; justify-content: space-between; align-items: center; padding: 16px; background: var(--bg-dark); border-radius: 8px; border: 1px solid var(--border-color);';
                    testItem.innerHTML = `
                        <div>
                            <div style="font-weight: 600; margin-bottom: 4px;">${stock.name || 'æœªå‘½å'} (${stock.code})</div>
                            <div style="font-size: 12px; color: var(--text-secondary);">ç‚¹å‡»æµ‹è¯•æŒ‰é’®ç«‹å³è¿è¡Œä¸€æ¬¡åˆ†æ</div>
                        </div>
                        <button class="btn btn-test" onclick="testStockAnalysis('${stock.code}'); return false;">ğŸ§ª æµ‹è¯•åˆ†æ</button>
                    `;
                    container.appendChild(testItem);
                }
            });

            if (container.innerHTML === '') {
                container.innerHTML = '<div style="text-align: center; color: var(--text-secondary); padding: 40px;">æš‚æ— å¯ç”¨çš„è‚¡ç¥¨ï¼Œè¯·åœ¨è‚¡ç¥¨é…ç½®ä¸­å¯ç”¨è‚¡ç¥¨</div>';
            }
        }

        // æµ‹è¯•è‚¡ç¥¨åˆ†æ
        async function testStockAnalysis(code) {
            // è·å–æŒ‰é’®å…ƒç´ ï¼ˆé€šè¿‡äº‹ä»¶æˆ–è€…é€šè¿‡ä»£ç æŸ¥æ‰¾ï¼‰
            let btn;
            if (event && event.target) {
                btn = event.target;
            } else {
                // å¦‚æœæ²¡æœ‰eventï¼Œé€šè¿‡codeæŸ¥æ‰¾å¯¹åº”çš„æŒ‰é’®
                const buttons = document.querySelectorAll('.btn-test');
                for (let b of buttons) {
                    if (b.textContent.includes('æµ‹è¯•åˆ†æ') && b.onclick && b.onclick.toString().includes(code)) {
                        btn = b;
                        break;
                    }
                }
            }
            
            if (!btn) {
                // å¦‚æœæ‰¾ä¸åˆ°æŒ‰é’®ï¼Œåˆ›å»ºä¸€ä¸ªä¸´æ—¶çš„
                btn = { disabled: false, textContent: '', style: {} };
            }
            
            const originalText = btn.textContent || 'ğŸ§ª æµ‹è¯•åˆ†æ';
            btn.disabled = true;
            btn.textContent = 'â³ åˆ†æä¸­...';

            try {
                console.log(`å¼€å§‹æµ‹è¯•è‚¡ç¥¨åˆ†æ: ${code}`);
                const response = await fetch(`/api/test/stock/${code}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });
                
                if (!response.ok) {
                    throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                }
                
                const result = await response.json();
                console.log('æµ‹è¯•ç»“æœ:', result);

                // æ£€æŸ¥è¿”å›ç»“æœ
                if (result.code === 0) {
                    // æ£€æŸ¥æ˜¯å¦æœ‰ç»“æœæ•°æ®ï¼ˆå¯èƒ½æ˜¯result.data.resultæˆ–result.dataï¼‰
                    let analysisResult = null;
                    if (result.data && result.data.result) {
                        analysisResult = result.data.result;
                    } else if (result.data && result.data.signal) {
                        // ç›´æ¥è¿”å›åˆ†æç»“æœçš„æƒ…å†µ
                        analysisResult = result.data;
                    }
                    
                    if (analysisResult) {
                        const signal = analysisResult.signal || 'N/A';
                        const signalText = getSignalText(signal); // ä½¿ç”¨ä¸­æ–‡ä¿¡å·
                        const confidence = analysisResult.confidence || 'N/A';
                        showAlert('success', `âœ… è‚¡ç¥¨ ${code} åˆ†æå®Œæˆï¼ä¿¡å·: ${signalText}, ä¿¡å¿ƒåº¦: ${confidence}%`);
                        // æ˜¾ç¤ºåˆ†æç»“æœï¼ˆä¸ä¼ navItemElementï¼Œå› ä¸ºæ˜¯ä»ä»£ç è°ƒç”¨ï¼‰
                        showPage('analysis', null);
                        displayAnalysisResult(code, analysisResult);
                    } else {
                        // APIè¿”å›æˆåŠŸä½†æ ¼å¼ä¸å¯¹
                        console.error('åˆ†æç»“æœæ ¼å¼é”™è¯¯:', result);
                        showAlert('warning', `âš ï¸ åˆ†æå®Œæˆä½†ç»“æœæ ¼å¼å¼‚å¸¸: ${result.message || 'è¯·æŸ¥çœ‹æ§åˆ¶å°æ—¥å¿—'}`);
                    }
                } else {
                    showAlert('error', `âŒ åˆ†æå¤±è´¥: ${result.message || 'æœªçŸ¥é”™è¯¯'}`);
                }
            } catch (error) {
                console.error('æµ‹è¯•è‚¡ç¥¨åˆ†æå¤±è´¥:', error);
                showAlert('error', `âŒ æµ‹è¯•å¤±è´¥: ${error.message || 'ç½‘ç»œé”™è¯¯æˆ–æœåŠ¡å¼‚å¸¸'}`);
            } finally {
                btn.disabled = false;
                btn.textContent = originalText;
            }
        }

        // æ˜¾ç¤ºåˆ†æç»“æœ
        function displayAnalysisResult(code, result) {
            const container = document.getElementById('analysisResults');
            const signal = result.signal || 'N/A';
            const signalText = getSignalText(signal); // ä½¿ç”¨ä¸­æ–‡ä¿¡å·
            const signalColor = signal === 'BUY' ? 'var(--success-color)' : 
                              signal === 'SELL' ? 'var(--danger-color)' : 
                              'var(--warning-color)';
            
            container.innerHTML = `
                <div class="card" style="background: var(--bg-dark);">
                    <div class="card-header">
                        <div class="card-title">${code} åˆ†æç»“æœ</div>
                    </div>
                    <div style="padding: 20px;">
                        <div class="grid-2" style="margin-bottom: 20px;">
                            <div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">ä¿¡å·</div>
                                <div style="font-size: 24px; font-weight: 700; color: ${signalColor};">${signalText}</div>
                            </div>
                            <div>
                                <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">ä¿¡å¿ƒåº¦</div>
                                <div style="font-size: 24px; font-weight: 700;">${result.confidence}%</div>
                            </div>
                        </div>
                        <div style="margin-top: 20px;">
                            <div style="font-size: 13px; color: var(--text-secondary); margin-bottom: 8px;">åˆ†æç†ç”±</div>
                            <div style="padding: 16px; background: var(--bg-card); border-radius: 8px; white-space: pre-wrap; line-height: 1.6;">${result.reasoning || 'æ— '}</div>
                        </div>
                    </div>
                </div>
            `;
        }

        // æ·»åŠ è‚¡ç¥¨
        function addStock() {
            if (!currentConfig.stocks) {
                currentConfig.stocks = [];
            }
            currentConfig.stocks.push({
                code: '',
                name: '',
                enabled: true,
                scan_interval_minutes: 5,
                min_confidence: 70
            });
            renderStockList(currentConfig.stocks);
        }

        // åˆ é™¤è‚¡ç¥¨
        function removeStock(index) {
            if (confirm('ç¡®å®šè¦åˆ é™¤è¿™åªè‚¡ç¥¨å—ï¼Ÿ')) {
                currentConfig.stocks.splice(index, 1);
                renderStockList(currentConfig.stocks);
            }
        }

        // ä¿å­˜é…ç½®
        async function saveConfig() {
            // æ”¶é›†ç³»ç»Ÿé…ç½®
            const config = collectFormData();

            if (!config.tdx_api_url) {
                showAlert('error', 'TDX APIåœ°å€ä¸èƒ½ä¸ºç©º');
                return;
            }

            // ä¿ç•™å·²æœ‰çš„è‚¡ç¥¨é…ç½®å’Œé€šçŸ¥é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentConfig) {
                if (currentConfig.stocks && currentConfig.stocks.length > 0) {
                    config.stocks = currentConfig.stocks;
                }
                if (currentConfig.notification) {
                    config.notification = currentConfig.notification;
                }
            }

            // å¦‚æœæ²¡æœ‰è‚¡ç¥¨é…ç½®ï¼Œè‡³å°‘ä¿ç•™ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆé¿å…éªŒè¯å¤±è´¥ï¼‰
            if (!config.stocks || config.stocks.length === 0) {
                config.stocks = [];
            }

            // å¦‚æœæ²¡æœ‰é€šçŸ¥é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
            if (!config.notification) {
                config.notification = {
                    enabled: false,
                    dingtalk: {
                        enabled: false,
                        webhook_url: "",
                        secret: ""
                    },
                    feishu: {
                        enabled: false,
                        webhook_url: "",
                        secret: ""
                    }
                };
            }

            try {
                const button = event.target;
                button.disabled = true;
                button.textContent = 'â³ ä¿å­˜ä¸­...';

                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();

                if (result.code === 0) {
                    showAlert('success', 'âœ… é…ç½®å·²ä¿å­˜ï¼âš ï¸ è¯·é‡å¯åç«¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆã€‚');
                    currentConfig = config;
                    
                    // æ˜¾ç¤ºé‡å¯æç¤º
                    setTimeout(() => {
                        const restartHint = document.createElement('div');
                        restartHint.className = 'alert alert-warning';
                        restartHint.style.marginTop = '10px';
                        restartHint.innerHTML = `
                            <strong>ğŸ“‹ é‡å¯è¯´æ˜ï¼š</strong><br>
                            é…ç½®å·²ä¿å­˜åˆ°æ–‡ä»¶ï¼Œä½†éœ€è¦é‡å¯åç«¯æœåŠ¡æ‰èƒ½ç”Ÿæ•ˆã€‚<br>
                            <small>â€¢ è‚¡ç¥¨åˆ—è¡¨å˜æ›´ï¼ˆæ·»åŠ /åˆ é™¤/ä¿®æ”¹ï¼‰éœ€è¦é‡å¯<br>
                            â€¢ AIé…ç½®å˜æ›´ï¼ˆAPIå¯†é’¥ã€æ¨¡å‹ï¼‰éœ€è¦é‡å¯<br>
                            â€¢ TDX APIåœ°å€å˜æ›´éœ€è¦é‡å¯<br>
                            â€¢ å…¶ä»–é…ç½®å˜æ›´ä¹Ÿéœ€è¦é‡å¯</small>
                        `;
                        document.getElementById('alertContainer').appendChild(restartHint);
                    }, 500);
                } else {
                    showAlert('error', 'ä¿å­˜å¤±è´¥: ' + result.message);
                }

                button.disabled = false;
                button.textContent = 'ğŸ’¾ ä¿å­˜é…ç½®';
            } catch (error) {
                showAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜è‚¡ç¥¨é…ç½®
        async function saveStockConfig() {
            // æ”¶é›†ç³»ç»Ÿé…ç½®
            const config = collectFormData();
            // æ”¶é›†è‚¡ç¥¨æ•°æ®
            config.stocks = collectStockData();
            
            // ä¿ç•™å·²æœ‰çš„é€šçŸ¥é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentConfig && currentConfig.notification) {
                config.notification = currentConfig.notification;
            } else if (!config.notification) {
                // å¦‚æœæ²¡æœ‰é€šçŸ¥é…ç½®ï¼Œåˆ›å»ºé»˜è®¤é…ç½®
                config.notification = {
                    enabled: false,
                    dingtalk: {
                        enabled: false,
                        webhook_url: "",
                        secret: ""
                    },
                    feishu: {
                        enabled: false,
                        webhook_url: "",
                        secret: ""
                    }
                };
            }
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.code === 0) {
                    showAlert('success', 'âœ… è‚¡ç¥¨é…ç½®å·²ä¿å­˜ï¼âš ï¸ è¯·é‡å¯åç«¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆã€‚');
                    currentConfig = config;
                } else {
                    showAlert('error', 'ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // ä¿å­˜é€šçŸ¥é…ç½®
        async function saveNotificationConfig() {
            // æ”¶é›†ç³»ç»Ÿé…ç½®
            const config = collectFormData();
            // æ”¶é›†é€šçŸ¥æ•°æ®
            config.notification = collectNotificationData();
            
            // ä¿ç•™å·²æœ‰çš„è‚¡ç¥¨é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ï¼‰
            if (currentConfig && currentConfig.stocks && currentConfig.stocks.length > 0) {
                config.stocks = currentConfig.stocks;
            } else if (!config.stocks || config.stocks.length === 0) {
                // å¦‚æœæ²¡æœ‰è‚¡ç¥¨é…ç½®ï¼Œè‡³å°‘ä¿ç•™ä¸€ä¸ªç©ºæ•°ç»„ï¼ˆé¿å…éªŒè¯å¤±è´¥ï¼‰
                config.stocks = [];
            }
            
            try {
                const response = await fetch('/api/config', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(config)
                });

                const result = await response.json();
                if (result.code === 0) {
                    showAlert('success', 'âœ… é€šçŸ¥é…ç½®å·²ä¿å­˜ï¼âš ï¸ è¯·é‡å¯åç«¯æœåŠ¡ä½¿é…ç½®ç”Ÿæ•ˆã€‚');
                    currentConfig = config;
                } else {
                    showAlert('error', 'ä¿å­˜å¤±è´¥: ' + result.message);
                }
            } catch (error) {
                showAlert('error', 'ä¿å­˜å¤±è´¥: ' + error.message);
            }
        }

        // æ”¶é›†è¡¨å•æ•°æ®
        function collectFormData() {
            return {
                tdx_api_url: document.getElementById('tdx_api_url').value,
                ai_config: {
                    provider: document.getElementById('ai_provider').value,
                    deepseek_key: document.getElementById('deepseek_key').value,
                    qwen_key: document.getElementById('qwen_key').value,
                    custom_api_url: document.getElementById('custom_api_url').value,
                    custom_api_key: document.getElementById('custom_api_key').value,
                    custom_model_name: document.getElementById('custom_model_name').value
                },
                trading_time: {
                    enable_check: document.getElementById('trading_time_enable').checked,
                    trading_hours: JSON.parse(document.getElementById('trading_hours').value || '["09:30-11:30", "13:00-15:00"]'),
                    timezone: document.getElementById('timezone').value
                },
                api_server_port: parseInt(document.getElementById('api_server_port').value) || 9090,
                log_dir: document.getElementById('log_dir').value || 'stock_analysis_logs',
                analysis_history_limit: parseInt(document.getElementById('analysis_history_limit').value) || 20,
                // API Tokenå¤„ç†ï¼šå¦‚æœè¾“å…¥æ¡†å€¼åŒ…å«*ï¼ˆéšè—æ˜¾ç¤ºï¼‰ï¼Œä½¿ç”¨currentConfigä¸­çš„å€¼ï¼›å¦åˆ™ä½¿ç”¨æ–°å€¼
                api_token: (() => {
                    const inputValue = document.getElementById('api_token').value;
                    // å¦‚æœè¾“å…¥æ¡†å€¼æ˜¯éšè—æ˜¾ç¤ºçš„ï¼ˆåŒ…å«*ï¼‰ï¼Œä½¿ç”¨åŸæœ‰é…ç½®
                    if (inputValue.includes('*') && currentConfig && currentConfig.api_token) {
                        return currentConfig.api_token;
                    }
                    // å¦‚æœè¾“å…¥æ¡†æ˜¯æ–°å€¼ï¼Œä½¿ç”¨æ–°å€¼ï¼›å¦‚æœä¸ºç©ºï¼Œä½¿ç”¨é»˜è®¤å€¼
                    return inputValue.trim() !== '' ? inputValue : (currentConfig?.api_token || '1122334455667788');
                })()
            };
        }

        // é‡å¯åç«¯æœåŠ¡
        async function restartBackend() {
            // ç¡®è®¤æ“ä½œ
            if (!confirm('âš ï¸ ç¡®å®šè¦é‡å¯åç«¯æœåŠ¡å—ï¼Ÿ\n\né‡å¯åï¼š\n- å½“å‰æ‰€æœ‰åˆ†æå™¨å°†åœæ­¢\n- é…ç½®å°†é‡æ–°åŠ è½½\n- æœåŠ¡å°†åœ¨3ç§’åè‡ªåŠ¨é‡å¯\n- é¡µé¢å°†åœ¨5ç§’åè‡ªåŠ¨åˆ·æ–°\n\næ³¨æ„ï¼šå¦‚æœä½¿ç”¨ manage_backend.sh å¯åŠ¨ï¼Œå°†è‡ªåŠ¨é‡å¯ï¼›å¦åˆ™è¯·æ‰‹åŠ¨é‡å¯æœåŠ¡\n\nç»§ç»­å—ï¼Ÿ')) {
                return;
            }

            try {
                // è·å–API Tokenï¼ˆä¼˜å…ˆä»localStorageè¯»å–çœŸå®Tokenï¼Œå¦‚æœä¸å­˜åœ¨åˆ™ä»è¾“å…¥æ¡†è¯»å–ï¼‰
                let apiToken = '';
                if (typeof(Storage) !== "undefined") {
                    apiToken = localStorage.getItem('api_token_real');
                }
                // å¦‚æœlocalStorageä¸­æ²¡æœ‰ï¼Œä»è¾“å…¥æ¡†è¯»å–ï¼ˆå¯èƒ½æ˜¯æ–°è®¾ç½®çš„ï¼‰
                if (!apiToken) {
                    apiToken = document.getElementById('api_token').value;
                    // å¦‚æœè¾“å…¥æ¡†çš„å€¼åŒ…å«*å·ï¼ˆè¡¨ç¤ºæ˜¯éšè—æ˜¾ç¤ºï¼‰ï¼Œå°è¯•ä»currentConfigè¯»å–
                    if (apiToken.includes('*') && currentConfig && currentConfig.api_token) {
                        apiToken = currentConfig.api_token;
                    }
                }
                
                if (!apiToken || apiToken.trim() === '') {
                    showAlert('error', 'âŒ è¯·å…ˆé…ç½®API Tokenã€‚å¯åœ¨ç³»ç»Ÿé…ç½®é¡µé¢çš„"API Token"å­—æ®µä¸­è®¾ç½®ã€‚\n\næ³¨æ„ï¼šå¦‚æœTokenæ˜¾ç¤ºä¸º****ï¼Œè¯·åœ¨ä¿å­˜é…ç½®åé‡æ–°åŠ è½½é¡µé¢ï¼Œæˆ–ç›´æ¥åœ¨é…ç½®æ–‡ä»¶ä¸­è®¾ç½®api_tokenå­—æ®µã€‚');
                    return;
                }

                showAlert('info', 'â³ æ­£åœ¨é‡å¯åç«¯æœåŠ¡ï¼Œè¯·ç¨å€™...');

                const response = await fetch('/api/system/restart', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-API-Token': apiToken
                    },
                    body: JSON.stringify({
                        token: apiToken
                    })
                });

                // æ£€æŸ¥å“åº”çŠ¶æ€
                if (!response.ok) {
                    if (response.status === 404) {
                        throw new Error('APIè·¯ç”±ä¸å­˜åœ¨ã€‚è¯·ç¡®ä¿åç«¯å·²é‡æ–°ç¼–è¯‘å¹¶é‡å¯ä»¥åº”ç”¨æœ€æ–°ä»£ç ã€‚');
                    } else if (response.status === 401 || response.status === 403) {
                        throw new Error('TokenéªŒè¯å¤±è´¥ï¼Œè¯·æ£€æŸ¥API Tokenæ˜¯å¦æ­£ç¡®ã€‚');
                    } else {
                        throw new Error(`HTTPé”™è¯¯: ${response.status} ${response.statusText}`);
                    }
                }

                // è·å–å“åº”å†…å®¹ç±»å‹
                const contentType = response.headers.get('content-type');
                if (!contentType || !contentType.includes('application/json')) {
                    const text = await response.text();
                    throw new Error(`æœåŠ¡å™¨è¿”å›äº†éJSONæ ¼å¼çš„å“åº”: ${text.substring(0, 100)}`);
                }

                const result = await response.json();

                if (result.code === 0) {
                    showAlert('success', 'âœ… ' + result.message + '\n\né¡µé¢å°†åœ¨5ç§’åè‡ªåŠ¨åˆ·æ–°...');
                    // ç­‰å¾…5ç§’ååˆ·æ–°é¡µé¢
                    setTimeout(() => {
                        window.location.reload();
                    }, 5000);
                } else {
                    showAlert('error', 'âŒ é‡å¯å¤±è´¥: ' + (result.message || 'æœªçŸ¥é”™è¯¯'));
                }
            } catch (error) {
                console.error('é‡å¯è¯·æ±‚å¤±è´¥:', error);
                let errorMsg = error.message || 'æœªçŸ¥é”™è¯¯';
                
                // å¦‚æœæ˜¯JSONè§£æé”™è¯¯ï¼Œæä¾›æ›´å‹å¥½çš„æç¤º
                if (errorMsg.includes('JSON') || errorMsg.includes('Unexpected')) {
                    errorMsg = 'æœåŠ¡å™¨å“åº”æ ¼å¼é”™è¯¯ã€‚å¯èƒ½æ˜¯ï¼š\n1. åç«¯ç‰ˆæœ¬è¿‡æ—§ï¼Œè¯·é‡æ–°ç¼–è¯‘å¹¶é‡å¯\n2. æœåŠ¡æ­£åœ¨é‡å¯ä¸­ï¼Œè¯·ç¨å€™å†è¯•';
                }
                
                showAlert('error', 'âŒ é‡å¯è¯·æ±‚å¤±è´¥: ' + errorMsg + '\n\næç¤ºï¼š\n- å¦‚æœè¿”å›404é”™è¯¯ï¼Œè¯·ç¡®ä¿åç«¯å·²é‡æ–°ç¼–è¯‘å¹¶é‡å¯\n- å¦‚æœæœåŠ¡æ­£åœ¨é‡å¯ï¼Œè¯·ç­‰å¾…å‡ ç§’ååˆ·æ–°é¡µé¢');
                
                // å¦‚æœæ˜¯404é”™è¯¯ï¼Œä¸è‡ªåŠ¨åˆ·æ–°ï¼Œè®©ç”¨æˆ·æ‰‹åŠ¨åˆ·æ–°
                if (errorMsg.includes('404') || errorMsg.includes('è·¯ç”±ä¸å­˜åœ¨')) {
                    setTimeout(() => {
                        if (confirm('âš ï¸ APIè·¯ç”±ä¸å­˜åœ¨ï¼Œå¯èƒ½æ˜¯åç«¯ç‰ˆæœ¬è¿‡æ—§ã€‚\n\nè¯·å…ˆé‡æ–°ç¼–è¯‘åç«¯ä»£ç ï¼š\ngo build -o stock_analyzer main_stock.go\n\nç„¶åé‡å¯åç«¯æœåŠ¡ã€‚\n\næ˜¯å¦ç°åœ¨åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                            window.location.reload();
                        }
                    }, 2000);
                } else {
                    // å¦‚æœè¿æ¥å¤±è´¥ï¼Œå¯èƒ½æ˜¯æœåŠ¡æ­£åœ¨é‡å¯ï¼Œç­‰å¾…ååˆ·æ–°
                    setTimeout(() => {
                        if (confirm('è¿æ¥å·²æ–­å¼€ï¼ŒæœåŠ¡å¯èƒ½æ­£åœ¨é‡å¯ã€‚æ˜¯å¦åˆ·æ–°é¡µé¢ï¼Ÿ')) {
                            window.location.reload();
                        }
                    }, 3000);
                }
            }
        }

        // æ”¶é›†è‚¡ç¥¨æ•°æ®
        function collectStockData() {
            const stocks = [];
            const stockCodes = document.querySelectorAll('.stock-code');
            
            stockCodes.forEach((input, index) => {
                const stock = {
                    code: input.value,
                    name: document.querySelector(`.stock-name[data-index="${index}"]`).value,
                    enabled: document.querySelector(`.stock-enabled[data-index="${index}"]`).checked,
                    scan_interval_minutes: parseInt(document.querySelector(`.stock-interval[data-index="${index}"]`).value) || 5,
                    min_confidence: parseInt(document.querySelector(`.stock-confidence[data-index="${index}"]`).value) || 70
                };
                
                const quantityInput = document.querySelector(`.stock-position-quantity[data-index="${index}"]`);
                const priceInput = document.querySelector(`.stock-buy-price[data-index="${index}"]`);
                const buyDateInput = document.querySelector(`.stock-buy-date[data-index="${index}"]`);
                
                if (quantityInput && priceInput && quantityInput.value && priceInput.value) {
                    stock.position_quantity = parseInt(quantityInput.value);
                    stock.buy_price = parseFloat(priceInput.value);
                    if (buyDateInput && buyDateInput.value) {
                        stock.buy_date = buyDateInput.value;
                    }
                }
                
                stocks.push(stock);
            });
            
            return stocks;
        }

        // æ”¶é›†é€šçŸ¥æ•°æ®
        function collectNotificationData() {
            return {
                enabled: document.getElementById('notification_enabled').checked,
                dingtalk: {
                    enabled: document.getElementById('dingtalk_enabled').checked,
                    webhook_url: document.getElementById('dingtalk_webhook').value,
                    secret: document.getElementById('dingtalk_secret').value
                },
                feishu: {
                    enabled: document.getElementById('feishu_enabled').checked,
                    webhook_url: document.getElementById('feishu_webhook').value,
                    secret: document.getElementById('feishu_secret').value
                }
            };
        }

        // åŠ è½½è‚¡ç¥¨åˆ—è¡¨
        async function loadStocks() {
            const loadingEl = document.getElementById('loadingContainerStocks');
            const containerEl = document.getElementById('stocksContainer');
            
            try {
                if (loadingEl) loadingEl.style.display = 'block';
                if (containerEl) containerEl.style.display = 'none';

                if (!currentConfig) {
                    await loadConfig();
                }

                if (currentConfig && currentConfig.stocks && currentConfig.stocks.length > 0) {
                    renderStockList(currentConfig.stocks);
                } else {
                    // å¦‚æœæ²¡æœ‰è‚¡ç¥¨é…ç½®ï¼Œæ˜¾ç¤ºç©ºåˆ—è¡¨ï¼Œå…è®¸æ·»åŠ 
                    if (currentConfig && !currentConfig.stocks) {
                        currentConfig.stocks = [];
                    }
                    renderStockList(currentConfig?.stocks || []);
                }
                
                if (loadingEl) loadingEl.style.display = 'none';
                if (containerEl) containerEl.style.display = 'block';
            } catch (error) {
                console.error('åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥:', error);
                showAlert('error', 'åŠ è½½è‚¡ç¥¨åˆ—è¡¨å¤±è´¥: ' + error.message);
                // å³ä½¿åŠ è½½å¤±è´¥ï¼Œä¹Ÿæ˜¾ç¤ºç•Œé¢å…è®¸ç”¨æˆ·æ“ä½œ
                if (loadingEl) loadingEl.style.display = 'none';
                if (containerEl) containerEl.style.display = 'block';
                // æ˜¾ç¤ºç©ºåˆ—è¡¨
                renderStockList([]);
            }
        }

        // æ˜¾ç¤ºæç¤ºä¿¡æ¯
        function showAlert(type, message) {
            const container = document.getElementById('alertContainer');
            const alert = document.createElement('div');
            alert.className = `alert alert-${type}`;
            alert.textContent = message;
            container.innerHTML = '';
            container.appendChild(alert);

            setTimeout(() => {
                alert.style.opacity = '0';
                alert.style.transition = 'opacity 0.5s';
                setTimeout(() => alert.remove(), 500);
            }, 3000);

            window.scrollTo({ top: 0, behavior: 'smooth' });
        }
    </script>
</body>
</html>
