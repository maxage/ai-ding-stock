name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒåˆ° GHCR

on:
  workflow_dispatch:
    inputs:
      skip_cache:
        description: 'æž„å»ºæ—¶æ˜¯å¦è·³è¿‡ç¼“å­˜'
        required: false
        default: 'false'
        type: choice
        options:
          - 'false'
          - 'true'

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
      delete: packages

    steps:
      - name: æ£€å‡ºä»£ç ä»“åº“
        uses: actions/checkout@v4

      - name: è®¾ç½® Docker Buildx
        uses: docker/setup-buildx-action@v3

      - name: ç™»å½• GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: èŽ·å–å½“å‰é•œåƒä¿¡æ¯ï¼ˆç”¨äºŽåŽç»­æ¸…ç†ï¼‰
        id: old-image
        run: |
          # å°è¯•èŽ·å–å½“å‰ latest æ ‡ç­¾çš„ digestï¼ˆå¦‚æžœå­˜åœ¨ï¼‰
          OLD_DIGEST=$(docker manifest inspect ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest 2>/dev/null | grep -oP '"digest":\s*"\K[^"]+' | head -1 || echo "")
          if [ -n "$OLD_DIGEST" ]; then
            echo "old_digest=$OLD_DIGEST" >> $GITHUB_OUTPUT
            echo "æ‰¾åˆ°æ—§é•œåƒ: $OLD_DIGEST"
          else
            echo "old_digest=" >> $GITHUB_OUTPUT
            echo "æœªæ‰¾åˆ°æ—§é•œåƒï¼Œå¯èƒ½æ˜¯é¦–æ¬¡æž„å»º"
          fi
        continue-on-error: true

      - name: æå– Docker å…ƒæ•°æ®ï¼ˆæ ‡ç­¾ã€æ ‡ç­¾ç­‰ï¼‰
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=raw,value=latest

      - name: æž„å»ºå¹¶æŽ¨é€ Docker é•œåƒ
        id: build
        uses: docker/build-push-action@v5
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: ${{ github.event.inputs.skip_cache == 'true' && '' || 'type=gha' }}
          cache-to: ${{ github.event.inputs.skip_cache == 'true' && '' || 'type=gha,mode=max' }}
          platforms: linux/amd64
          no-cache: ${{ github.event.inputs.skip_cache == 'true' }}

      - name: èŽ·å–æ–°æž„å»ºçš„é•œåƒ digest
        id: new-image
        run: |
          NEW_DIGEST="${{ steps.build.outputs.digest }}"
          echo "new_digest=$NEW_DIGEST" >> $GITHUB_OUTPUT
          echo "æ–°é•œåƒæ‘˜è¦: $NEW_DIGEST"
          # ä»Ž digest ä¸­æå– SHA256 éƒ¨åˆ†ï¼ˆåŽ»æŽ‰ sha256: å‰ç¼€ï¼‰
          if [[ $NEW_DIGEST == sha256:* ]]; then
            SHA256_ONLY="${NEW_DIGEST#sha256:}"
            echo "sha256=$SHA256_ONLY" >> $GITHUB_OUTPUT
            echo "SHA256: $SHA256_ONLY"
          fi

      - name: åˆ é™¤æ—§çš„é•œåƒç‰ˆæœ¬
        if: steps.build.outcome == 'success' && steps.new-image.outputs.sha256 != ''
        run: |
          echo "ðŸ—‘ï¸  å¼€å§‹æ¸…ç†æ—§é•œåƒç‰ˆæœ¬..."
          
          PACKAGE_NAME="${{ env.IMAGE_NAME }}"
          OWNER="${{ github.repository_owner }}"
          CURRENT_DIGEST="${{ steps.new-image.outputs.sha256 }}"
          
          if [ -z "$CURRENT_DIGEST" ]; then
            echo "âš ï¸  æ— æ³•èŽ·å–æ–°é•œåƒçš„ digestï¼Œè·³è¿‡æ¸…ç†"
            exit 0
          fi
          
          echo "âœ… å½“å‰æœ€æ–°é•œåƒ digest: sha256:$CURRENT_DIGEST"
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºç»„ç»‡ä»“åº“ï¼ˆé€šè¿‡æ£€æŸ¥ä»“åº“ç±»åž‹ï¼‰
          # å¯¹äºŽä¸ªäººä»“åº“ï¼ŒAPI è·¯å¾„åº”è¯¥æ˜¯ users/$OWNER
          # å¯¹äºŽç»„ç»‡ä»“åº“ï¼ŒAPI è·¯å¾„åº”è¯¥æ˜¯ orgs/$OWNER
          # æˆ‘ä»¬å…ˆå°è¯• orgsï¼Œå¦‚æžœå¤±è´¥å†å°è¯• users
          API_BASE=""
          
          # å°è¯•èŽ·å–åŒ…ä¿¡æ¯æ¥ç¡®å®šæ­£ç¡®çš„ API è·¯å¾„
          ORG_TEST=$(curl -s -f -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/orgs/$OWNER/packages/container/$PACKAGE_NAME" 2>/dev/null || echo "")
          
          if [ -n "$ORG_TEST" ]; then
            API_BASE="orgs/$OWNER"
            echo "ðŸ“¦ ä½¿ç”¨ç»„ç»‡ä»“åº“ API: $API_BASE"
          else
            API_BASE="users/$OWNER"
            echo "ðŸ“¦ ä½¿ç”¨ä¸ªäººä»“åº“ API: $API_BASE"
          fi
          
          # èŽ·å–æ‰€æœ‰åŒ…ç‰ˆæœ¬
          echo "ðŸ“¦ èŽ·å–æ‰€æœ‰åŒ…ç‰ˆæœ¬..."
          VERSIONS_JSON=$(curl -s -f \
            -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
            -H "Accept: application/vnd.github+json" \
            "https://api.github.com/$API_BASE/packages/container/$PACKAGE_NAME/versions" 2>/dev/null || echo "[]")
          
          if [ "$VERSIONS_JSON" = "[]" ] || [ -z "$VERSIONS_JSON" ]; then
            echo "â„¹ï¸  æ— æ³•èŽ·å–åŒ…ç‰ˆæœ¬åˆ—è¡¨æˆ–åˆ—è¡¨ä¸ºç©ºï¼Œè·³è¿‡æ¸…ç†"
            exit 0
          fi
          
          # æ£€æŸ¥æ˜¯å¦æœ‰ jq
          if ! command -v jq &> /dev/null; then
            echo "âš ï¸  jq æœªå®‰è£…ï¼Œæ— æ³•è§£æž JSONï¼Œè·³è¿‡æ¸…ç†"
            exit 0
          fi
          
          # ä½¿ç”¨ä¸´æ—¶æ–‡ä»¶å­˜å‚¨ç»Ÿè®¡ä¿¡æ¯ï¼ˆé¿å…å­shellå˜é‡ä½œç”¨åŸŸé—®é¢˜ï¼‰
          TEMP_DIR=$(mktemp -d)
          echo "0" > "$TEMP_DIR/kept"
          echo "0" > "$TEMP_DIR/deleted"
          
          # éåŽ†æ‰€æœ‰ç‰ˆæœ¬å¹¶åˆ é™¤æ—§ç‰ˆæœ¬
          echo "$VERSIONS_JSON" | jq -r '.[] | "\(.id)|\(.metadata.container.digest // empty)"' | while IFS='|' read -r version_id version_digest; do
            if [ -z "$version_digest" ]; then
              continue
            fi
            
            # åŽ»æŽ‰ sha256: å‰ç¼€
            VERSION_DIGEST_ONLY="${version_digest#sha256:}"
            
            # å¦‚æžœ digest ä¸æ˜¯å½“å‰æœ€æ–°ç‰ˆæœ¬ï¼Œåˆ™åˆ é™¤
            if [ "$VERSION_DIGEST_ONLY" != "$CURRENT_DIGEST" ]; then
              echo "ðŸ—‘ï¸  åˆ é™¤æ—§ç‰ˆæœ¬: $version_id (digest: sha256:$VERSION_DIGEST_ONLY)"
              DELETE_RESULT=$(curl -s -w "\n%{http_code}" -X DELETE \
                -H "Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}" \
                -H "Accept: application/vnd.github+json" \
                "https://api.github.com/$API_BASE/packages/container/$PACKAGE_NAME/versions/$version_id" 2>/dev/null)
              
              HTTP_CODE=$(echo "$DELETE_RESULT" | tail -1)
              if [ "$HTTP_CODE" = "204" ] || [ "$HTTP_CODE" = "200" ]; then
                DELETED=$(cat "$TEMP_DIR/deleted")
                echo $((DELETED + 1)) > "$TEMP_DIR/deleted"
                echo "âœ… å·²åˆ é™¤ç‰ˆæœ¬: $version_id"
              else
                echo "âš ï¸  åˆ é™¤ç‰ˆæœ¬ $version_id å¤±è´¥ (HTTP $HTTP_CODE)ï¼Œå¯èƒ½å·²è¢«åˆ é™¤"
              fi
            else
              KEPT=$(cat "$TEMP_DIR/kept")
              echo $((KEPT + 1)) > "$TEMP_DIR/kept"
              echo "âœ… ä¿ç•™å½“å‰ç‰ˆæœ¬: $version_id (digest: sha256:$VERSION_DIGEST_ONLY)"
            fi
          done
          
          KEPT=$(cat "$TEMP_DIR/kept")
          DELETED=$(cat "$TEMP_DIR/deleted")
          rm -rf "$TEMP_DIR"
          
          echo ""
          echo "âœ… æ¸…ç†å®Œæˆï¼"
          echo "   - ä¿ç•™ç‰ˆæœ¬: $KEPT"
          echo "   - åˆ é™¤ç‰ˆæœ¬: $DELETED"
        continue-on-error: true

      - name: æž„å»ºæ‘˜è¦
        run: |
          echo "## Docker é•œåƒæž„å»ºæ‘˜è¦ ðŸ³" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒä»“åº“:** \`${{ env.REGISTRY }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**é•œåƒåç§°:** \`${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ ‡ç­¾:** \`latest\`" >> $GITHUB_STEP_SUMMARY
          echo "**æ‘˜è¦:** \`${{ steps.build.outputs.digest }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ‹‰å–å‘½ä»¤" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`bash" >> $GITHUB_STEP_SUMMARY
          echo "docker pull ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}:latest" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### æ¸…ç†çŠ¶æ€" >> $GITHUB_STEP_SUMMARY
          if [ -n "${{ steps.old-image.outputs.old_digest }}" ]; then
            echo "âœ… å·²æ¸…ç†æ—§é•œåƒç‰ˆæœ¬ï¼Œåªä¿ç•™æœ€æ–°çš„ä¸€ä¸ª" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸  é¦–æ¬¡æž„å»ºï¼Œæ— éœ€æ¸…ç†æ—§é•œåƒ" >> $GITHUB_STEP_SUMMARY
          fi
