services:
  # 股票分析后端服务
  stock-analyzer:
    # 本地编译配置（已注释，改为使用远程镜像）
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    # 使用远程镜像（GitHub Container Registry）
    image: ghcr.io/maxage/ai-ding-stock:latest
    container_name: stock-analyzer
    restart: unless-stopped
    ports:
      - "53290:9090"  # 主机端口:容器端口
    volumes:
      # 挂载配置文件（必须，可读写以支持Web配置保存）
      - ./config_stock.json:/app/config_stock.json
      # 挂载日志目录
      - ./stock_analysis_logs:/app/stock_analysis_logs
      # 挂载Web前端文件
      - ./web:/app/web
      # 挂载时区（可选）
      - /etc/localtime:/etc/localtime:ro
    environment:
      - TZ=Asia/Shanghai
      - LOG_LEVEL=info
      # API Token用于前端重启后端等操作（可选，如果配置文件中已设置则不需要）
      # 建议在生产环境中设置强密码，可通过环境变量覆盖配置文件中的Token
      - API_TOKEN=${API_TOKEN:-}
    networks:
      - stock-network
    healthcheck:
      test: ["CMD", "wget", "--no-verbose", "--tries=1", "--spider", "http://localhost:9090/api/stocks"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 60s
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"

  # Web前端服务（Nginx）
  stock-web:
    image: nginx:1.25-alpine
    container_name: stock-web
    restart: unless-stopped
    ports:
      - "53280:80"  # 主机端口:容器端口（Nginx默认80）
    volumes:
      # 挂载Web文件
      - ./web:/usr/share/nginx/html:ro
      # 挂载Nginx配置
      - ./nginx.conf:/etc/nginx/conf.d/default.conf:ro
    networks:
      - stock-network
    depends_on:
      - stock-analyzer
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
    # 添加权限相关配置（如果宿主机文件权限有问题）
    # user: "nginx"  # 确保使用 nginx 用户运行

networks:
  stock-network:
    driver: bridge
    ipam:
      config:
        - subnet: 172.28.0.0/16

